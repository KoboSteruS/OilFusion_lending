{% extends "admin/base.html" %}

{% block title %}Персонализация - Админка OilFusion{% endblock %}

{% block content %}
<div class="admin-edit-page">
    <div class="admin-page-header">
        <h1 class="admin-page-title">Редактирование "Персонализация"</h1>
        <p class="admin-page-subtitle">Управление контентом секции "Персонализация"</p>
    </div>

    <!-- Основная информация -->
    <div class="admin-section">
        <h2 class="admin-section-title">Основная информация</h2>
        <form method="POST" action="{{ url_for('admin.personalization_update', token=token) }}" class="admin-form" enctype="multipart/form-data">
            <div class="admin-form-group">
                <label for="title" class="admin-form-label">Заголовок секции</label>
                <input type="text" id="title" name="title" class="admin-form-input" 
                       value="{{ content.title }}" required>
            </div>

            <div class="admin-form-group">
                <label for="subtitle" class="admin-form-label">Подзаголовок</label>
                <input type="text" id="subtitle" name="subtitle" class="admin-form-input" 
                       value="{{ content.subtitle }}" required>
            </div>

            <div class="admin-form-group">
                <label for="info_text" class="admin-form-label">Заголовок информационного блока</label>
                <input type="text" id="info_text" name="info_text" class="admin-form-input" 
                       value="{{ content.info_text }}" required>
            </div>

            <div class="admin-form-group">
                <label for="info_description" class="admin-form-label">Описание информационного блока</label>
                <textarea id="info_description" name="info_description" class="admin-form-textarea" rows="4" required>{{ content.info_description }}</textarea>
            </div>

            <div class="admin-form-group">
                <label for="bio_well_url" class="admin-form-label">Ссылка на Bio-Well</label>
                <input type="url" id="bio_well_url" name="bio_well_url" class="admin-form-input" 
                       value="{{ content.bio_well_url }}" required>
            </div>

            <button type="submit" class="admin-btn admin-btn-primary">Сохранить изменения</button>
        </form>
    </div>

    <!-- Единая форма для ДНК-тестирования и AuraCloud -->
    <form method="POST" action="{{ url_for('admin.personalization_update', token=token) }}" class="admin-form" enctype="multipart/form-data">
    
    <!-- ДНК-тестирование -->
    <div class="admin-section">
        <h2 class="admin-section-title">ДНК-тестирование</h2>
            <div class="admin-form-group">
                <label for="dna_title" class="admin-form-label">Заголовок</label>
                <input type="text" id="dna_title" name="dna_title" class="admin-form-input" 
                       value="{{ content.dna_testing.title }}" required>
            </div>

            <div class="admin-form-group">
                <label for="dna_description" class="admin-form-label">Описание</label>
                <textarea id="dna_description" name="dna_description" class="admin-form-textarea" rows="3" required>{{ content.dna_testing.description }}</textarea>
            </div>

            <!-- Изображение ДНК-тестирования -->
            <div class="admin-form-group">
                <label class="admin-form-label">Изображение блока ДНК-тестирования</label>
                <div class="admin-image-upload-section">
                    <div class="admin-form-group">
                        <label for="dna_image" class="admin-form-label">Загрузить изображение</label>
                        <input type="file" id="dna_image" name="dna_image" class="admin-form-input" accept="image/*" onchange="previewImage(this, 'dna_preview')">
                    </div>
                    <div class="admin-form-group">
                        <label for="dna_image_url" class="admin-form-label">Или URL изображения</label>
                        <input type="url" id="dna_image_url" name="dna_image_url" class="admin-form-input" value="{{ content.dna_testing.image_url if content.dna_testing.image_url else '' }}" placeholder="/static/img/dna.jpg" onchange="previewImageFromUrl(this, 'dna_preview')">
                    </div>
                    <div class="admin-form-group">
                        <div class="admin-image-info">
                            <div id="dna_preview" class="admin-preview-image admin-preview-image--wide">
                                {% if content.dna_testing.image_url %}
                                <img src="{{ content.dna_testing.image_url }}" alt="Предварительный просмотр">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="admin-subsection-title">Особенности ДНК-тестирования</h3>
            {% for feature in content.dna_testing.features %}
            <div class="admin-form-group">
                <label for="dna_feature_{{ loop.index0 }}" class="admin-form-label">Особенность {{ loop.index }}</label>
                <div class="admin-form-row">
                    <input type="text" id="dna_feature_{{ loop.index0 }}" name="dna_feature_{{ loop.index0 }}" 
                           class="admin-form-input" value="{{ feature }}" required>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-outline" 
                            onclick="updateDnaFeature({{ loop.index0 }}, document.getElementById('dna_feature_{{ loop.index0 }}').value, 'update')">
                        Обновить
                    </button>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-danger" 
                            onclick="updateDnaFeature({{ loop.index0 }}, '', 'delete')">
                        Удалить
                    </button>
                </div>
            </div>
            {% endfor %}

            <div class="admin-form-group">
                <label for="dna_feature_new" class="admin-form-label">Добавить особенность</label>
                <div class="admin-form-row">
                    <input type="text" id="dna_feature_new" class="admin-form-input" placeholder="Новая особенность">
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-primary" onclick="updateDnaFeature(0, document.getElementById('dna_feature_new').value, 'add')">Добавить</button>
                </div>
            </div>

    </div>

    <!-- AuraCloud® 3D -->
    <div class="admin-section">
        <h2 class="admin-section-title">AuraCloud® 3D</h2>
            <div class="admin-form-group">
                <label for="auracloud_title" class="admin-form-label">Заголовок</label>
                <input type="text" id="auracloud_title" name="auracloud_title" class="admin-form-input" 
                       value="{{ content.auracloud.title }}" required>
            </div>

            <div class="admin-form-group">
                <label for="auracloud_description" class="admin-form-label">Описание</label>
                <textarea id="auracloud_description" name="auracloud_description" class="admin-form-textarea" rows="3" required>{{ content.auracloud.description }}</textarea>
            </div>

            <!-- Изображение AuraCloud 3D -->
            <div class="admin-form-group">
                <label class="admin-form-label">Изображение блока AuraCloud® 3D</label>
                <div class="admin-image-upload-section">
                    <div class="admin-form-group">
                        <label for="auracloud_image" class="admin-form-label">Загрузить изображение</label>
                        <input type="file" id="auracloud_image" name="auracloud_image" class="admin-form-input" accept="image/*" onchange="previewImage(this, 'auracloud_preview')">
                    </div>
                    <div class="admin-form-group">
                        <label for="auracloud_image_url" class="admin-form-label">Или URL изображения</label>
                        <input type="url" id="auracloud_image_url" name="auracloud_image_url" class="admin-form-input" value="{{ content.auracloud.image_url if content.auracloud.image_url else '' }}" placeholder="/static/img/auracloud.jpg" onchange="previewImageFromUrl(this, 'auracloud_preview')">
                    </div>
                    <div class="admin-form-group">
                        <div class="admin-image-info">
                            <div id="auracloud_preview" class="admin-preview-image admin-preview-image--wide">
                                {% if content.auracloud.image_url %}
                                <img src="{{ content.auracloud.image_url }}" alt="Предварительный просмотр">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="admin-subsection-title">Особенности AuraCloud® 3D</h3>
            {% for feature in content.auracloud.features %}
            <div class="admin-form-group">
                <label for="auracloud_feature_{{ loop.index0 }}" class="admin-form-label">Особенность {{ loop.index }}</label>
                <div class="admin-form-row">
                    <input type="text" id="auracloud_feature_{{ loop.index0 }}" name="auracloud_feature_{{ loop.index0 }}" 
                           class="admin-form-input" value="{{ feature }}" required>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-outline" 
                            onclick="updateAuracloudFeature({{ loop.index0 }}, document.getElementById('auracloud_feature_{{ loop.index0 }}').value, 'update')">
                        Обновить
                    </button>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-danger" 
                            onclick="updateAuracloudFeature({{ loop.index0 }}, '', 'delete')">
                        Удалить
                    </button>
                </div>
            </div>
            {% endfor %}

            <div class="admin-form-group">
                <label for="auracloud_feature_new" class="admin-form-label">Добавить особенность</label>
                <div class="admin-form-row">
                    <input type="text" id="auracloud_feature_new" class="admin-form-input" placeholder="Новая особенность">
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-primary" onclick="updateAuracloudFeature(0, document.getElementById('auracloud_feature_new').value, 'add')">Добавить</button>
                </div>
            </div>

    </div>
    
    <!-- Кнопка сохранения для всей формы -->
    <div class="admin-section">
        <button type="submit" class="admin-btn admin-btn-primary admin-btn-lg">Сохранить все изменения</button>
    </div>
    
    </form>
</div>

<script>
function updateDnaFeature(index, value, action) {
    const token = '{{ token }}';
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/${token}/admin/personalization/dna-feature/${index}/update`;
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'feature_text';
    input.value = value;

    const act = document.createElement('input');
    act.type = 'hidden';
    act.name = 'action';
    act.value = action || 'update';
    
    form.appendChild(input);
    form.appendChild(act);
    document.body.appendChild(form);
    form.submit();
}

function updateAuracloudFeature(index, value, action) {
    const token = '{{ token }}';
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/${token}/admin/personalization/auracloud-feature/${index}/update`;
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'feature_text';
    input.value = value;

    const act = document.createElement('input');
    act.type = 'hidden';
    act.name = 'action';
    act.value = action || 'update';
    
    form.appendChild(input);
    form.appendChild(act);
    document.body.appendChild(form);
    form.submit();
}

// Предварительный просмотр изображений
function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Предварительный просмотр">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function previewImageFromUrl(input, previewId) {
    const preview = document.getElementById(previewId);
    const url = input.value.trim();
    if (url) {
        preview.innerHTML = `<img src="${url}" alt="Предварительный просмотр" onerror="this.style.display='none'">`;
    } else {
        preview.innerHTML = '';
    }
}
</script>

{% endblock %}

