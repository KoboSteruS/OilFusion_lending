{% extends "admin/base.html" %}

{% block title %}О компании - Админка OilFusion{% endblock %}

{% block content %}
<div class="admin-edit-page">
    <div class="admin-page-header">
        <h1 class="admin-page-title">Редактирование "О компании"</h1>
        <p class="admin-page-subtitle">Управление контентом секции "О компании"</p>
    </div>

    <!-- Основная информация -->
    <div class="admin-section">
        <h2 class="admin-section-title">Основная информация</h2>
        <form method="POST" action="{{ url_for('admin.about_update', token=token) }}" class="admin-form" enctype="multipart/form-data">
            <div class="admin-form-group">
                <label for="title" class="admin-form-label">Заголовок секции</label>
                <input type="text" id="title" name="title" class="admin-form-input" 
                       value="{{ content.title }}" required>
            </div>

            <div class="admin-form-group">
                <label for="description" class="admin-form-label">Описание</label>
                <textarea id="description" name="description" class="admin-form-textarea" rows="4" required>{{ content.description }}</textarea>
            </div>

            <div class="admin-form-group">
                <label for="philosophy" class="admin-form-label">Философия</label>
                <textarea id="philosophy" name="philosophy" class="admin-form-textarea" rows="3" required>{{ content.philosophy }}</textarea>
            </div>

            <!-- Загрузка фонового изображения -->
            <div class="admin-form-group">
                <label class="admin-form-label">Фоновое изображение секции</label>
                <div class="admin-image-upload-section">
                    <div class="admin-form-group">
                        <label for="background_image" class="admin-form-label">Загрузить изображение</label>
                        <input type="file" id="background_image" name="background_image" class="admin-form-input" accept="image/*">
                        <div class="admin-form-help">PNG, JPG, JPEG, WEBP, GIF до 16MB</div>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="background_image_url" class="admin-form-label">Или URL изображения</label>
                        <input type="url" id="background_image_url" name="background_image_url" class="admin-form-input" 
                               value="{{ content.background_image_url if content.background_image_url else '' }}"
                               placeholder="/static/img/about-background.jpg">
                    </div>
                    
                    {% if content.background_image_url %}
                    <div class="admin-image-preview">
                        <img src="{{ content.background_image_url }}" alt="Превью фона" class="admin-preview-image">
                        <div class="admin-image-info">
                            <strong>Текущий фон:</strong> {{ content.background_image_url }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="admin-form-row">
                        <div class="admin-form-group">
                            <label for="background_overlay_opacity" class="admin-form-label">
                                Прозрачность наложения (0-1)
                            </label>
                            <input type="number" id="background_overlay_opacity" name="background_overlay_opacity" 
                                   class="admin-form-input" min="0" max="1" step="0.1" 
                                   value="{{ content.background_overlay_opacity if content.background_overlay_opacity is not none else 0.8 }}">
                        </div>
                        
                        <div class="admin-form-group">
                            <label for="background_overlay_color" class="admin-form-label">Цвет наложения</label>
                            <input type="color" id="background_overlay_color" name="background_overlay_color" 
                                   class="admin-form-input" 
                                   value="{{ content.background_overlay_color if content.background_overlay_color else '#FFFFFF' }}">
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="admin-btn admin-btn-primary">Сохранить изменения</button>
        </form>
    </div>

    <!-- Особенности -->
    <div class="admin-section">
        <div class="admin-section-header">
            <h2 class="admin-section-title">Особенности компании</h2>
            <button type="button" class="admin-btn admin-btn-secondary" onclick="showAddFeatureForm()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Добавить особенность
            </button>
        </div>

        <!-- Список особенностей -->
        <div class="admin-features-list">
            {% for feature in content.features %}
            <div class="admin-feature-item">
                <div class="admin-feature-content">
                    <h4 class="admin-feature-title">{{ feature.title }}</h4>
                    <p class="admin-feature-description">{{ feature.description }}</p>
                    <span class="admin-feature-icon">Иконка: {{ feature.icon }}</span>
                </div>
                <div class="admin-feature-actions">
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-outline" 
                            onclick="editFeature({{ loop.index0 }}, '{{ feature.title }}', '{{ feature.description }}', '{{ feature.icon }}')">
                        Редактировать
                    </button>
                    <form method="POST" action="{{ url_for('admin.about_feature_delete', token=token, index=loop.index0) }}" 
                          style="display: inline;" onsubmit="return confirm('Удалить особенность?')">
                        <button type="submit" class="admin-btn admin-btn-sm admin-btn-danger">Удалить</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Форма добавления особенности -->
    <div id="addFeatureForm" class="admin-section" style="display: none;">
        <h2 class="admin-section-title">Добавить особенность</h2>
        <form method="POST" action="{{ url_for('admin.about_feature_add', token=token) }}" class="admin-form" enctype="multipart/form-data">
            <div class="admin-form-group">
                <label for="feature_title" class="admin-form-label">Название</label>
                <input type="text" id="feature_title" name="feature_title" class="admin-form-input" required>
            </div>

            <div class="admin-form-group">
                <label for="feature_description" class="admin-form-label">Описание</label>
                <textarea id="feature_description" name="feature_description" class="admin-form-textarea" rows="3" required></textarea>
            </div>

            <div class="admin-form-group">
                <label for="feature_icon" class="admin-form-label">Иконка</label>
                <select id="feature_icon" name="feature_icon" class="admin-form-select">
                    <option value="aura">AuraCloud® 3D</option>
                    <option value="dna">ДНК-тестирование</option>
                    <option value="default">По умолчанию</option>
                </select>
            </div>

            <!-- Загрузка изображения для особенности -->
            <div class="admin-form-group">
                <label class="admin-form-label">Изображение особенности</label>
                <div class="admin-image-upload-section">
                    <div class="admin-form-group">
                        <label for="feature_image" class="admin-form-label">Загрузить изображение</label>
                        <input type="file" id="feature_image" name="feature_image" class="admin-form-input" accept="image/*">
                        <div class="admin-form-help">PNG, JPG, JPEG, WEBP, GIF до 16MB</div>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="feature_image_url" class="admin-form-label">Или URL изображения</label>
                        <input type="url" id="feature_image_url" name="feature_image_url" class="admin-form-input" 
                               placeholder="/static/img/aura-technology.jpg">
                    </div>
                </div>
            </div>

            <div class="admin-form-actions">
                <button type="submit" class="admin-btn admin-btn-primary">Добавить</button>
                <button type="button" class="admin-btn admin-btn-secondary" onclick="hideAddFeatureForm()">Отмена</button>
            </div>
        </form>
    </div>

    <!-- Форма редактирования особенности -->
    <div id="editFeatureForm" class="admin-section" style="display: none;">
        <h2 class="admin-section-title">Редактировать особенность</h2>
        <form id="editFeatureFormElement" method="POST" class="admin-form" enctype="multipart/form-data">
            <div class="admin-form-group">
                <label for="edit_feature_title" class="admin-form-label">Название</label>
                <input type="text" id="edit_feature_title" name="feature_title" class="admin-form-input" required>
            </div>

            <div class="admin-form-group">
                <label for="edit_feature_description" class="admin-form-label">Описание</label>
                <textarea id="edit_feature_description" name="feature_description" class="admin-form-textarea" rows="3" required></textarea>
            </div>

            <div class="admin-form-group">
                <label for="edit_feature_icon" class="admin-form-label">Иконка</label>
                <select id="edit_feature_icon" name="feature_icon" class="admin-form-select">
                    <option value="aura">AuraCloud® 3D</option>
                    <option value="dna">ДНК-тестирование</option>
                    <option value="default">По умолчанию</option>
                </select>
            </div>

            <!-- Загрузка изображения для редактируемой особенности -->
            <div class="admin-form-group">
                <label class="admin-form-label">Изображение особенности</label>
                <div class="admin-image-upload-section">
                    <div class="admin-form-group">
                        <label for="edit_feature_image" class="admin-form-label">Загрузить изображение</label>
                        <input type="file" id="edit_feature_image" name="feature_image" class="admin-form-input" accept="image/*">
                        <div class="admin-form-help">PNG, JPG, JPEG, WEBP, GIF до 16MB</div>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="edit_feature_image_url" class="admin-form-label">Или URL изображения</label>
                        <input type="url" id="edit_feature_image_url" name="feature_image_url" class="admin-form-input" 
                               placeholder="/static/img/aura-technology.jpg">
                    </div>
                </div>
            </div>

            <div class="admin-form-actions">
                <button type="submit" class="admin-btn admin-btn-primary">Сохранить</button>
                <button type="button" class="admin-btn admin-btn-secondary" onclick="hideEditFeatureForm()">Отмена</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddFeatureForm() {
    document.getElementById('addFeatureForm').style.display = 'block';
    document.getElementById('addFeatureForm').scrollIntoView({ behavior: 'smooth' });
}

function hideAddFeatureForm() {
    document.getElementById('addFeatureForm').style.display = 'none';
}

function editFeature(index, title, description, icon) {
    document.getElementById('edit_feature_title').value = title;
    document.getElementById('edit_feature_description').value = description;
    document.getElementById('edit_feature_icon').value = icon;
    
    const form = document.getElementById('editFeatureFormElement');
    const token = '{{ token }}';
    form.action = `/${token}/admin/about/feature/${index}/update`;
    
    document.getElementById('editFeatureForm').style.display = 'block';
    document.getElementById('editFeatureForm').scrollIntoView({ behavior: 'smooth' });
}

function hideEditFeatureForm() {
    document.getElementById('editFeatureForm').style.display = 'none';
}

// Предварительный просмотр изображения фона
document.getElementById('background_image').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.querySelector('.admin-image-preview');
            if (preview) {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Превью фона" class="admin-preview-image">
                    <div class="admin-image-info">
                        <strong>Новое изображение:</strong> ${file.name}
                    </div>
                `;
            } else {
                const newPreview = document.createElement('div');
                newPreview.className = 'admin-image-preview';
                newPreview.innerHTML = `
                    <img src="${e.target.result}" alt="Превью фона" class="admin-preview-image">
                    <div class="admin-image-info">
                        <strong>Новое изображение:</strong> ${file.name}
                    </div>
                `;
                document.querySelector('.admin-image-upload-section').appendChild(newPreview);
            }
        };
        reader.readAsDataURL(file);
    }
});

// Предварительный просмотр изображения особенности (добавление)
document.getElementById('feature_image').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const uploadSection = document.querySelector('#addFeatureForm .admin-image-upload-section');
            let preview = uploadSection.querySelector('.admin-image-preview');
            if (preview) {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Превью особенности" class="admin-preview-image">
                    <div class="admin-image-info">
                        <strong>Новое изображение:</strong> ${file.name}
                    </div>
                `;
            } else {
                const newPreview = document.createElement('div');
                newPreview.className = 'admin-image-preview';
                newPreview.innerHTML = `
                    <img src="${e.target.result}" alt="Превью особенности" class="admin-preview-image">
                    <div class="admin-image-info">
                        <strong>Новое изображение:</strong> ${file.name}
                    </div>
                `;
                uploadSection.appendChild(newPreview);
            }
        };
        reader.readAsDataURL(file);
    }
});

// Предварительный просмотр изображения особенности (редактирование)
document.getElementById('edit_feature_image').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const uploadSection = document.querySelector('#editFeatureForm .admin-image-upload-section');
            let preview = uploadSection.querySelector('.admin-image-preview');
            if (preview) {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Превью особенности" class="admin-preview-image">
                    <div class="admin-image-info">
                        <strong>Новое изображение:</strong> ${file.name}
                    </div>
                `;
            } else {
                const newPreview = document.createElement('div');
                newPreview.className = 'admin-image-preview';
                newPreview.innerHTML = `
                    <img src="${e.target.result}" alt="Превью особенности" class="admin-preview-image">
                    <div class="admin-image-info">
                        <strong>Новое изображение:</strong> ${file.name}
                    </div>
                `;
                uploadSection.appendChild(newPreview);
            }
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}

